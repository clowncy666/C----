# ============================================
# Logger Library Makefile
# ============================================

# ç¼–è¯‘å™¨è®¾ç½®
CXX := g++
AR := ar
CXXFLAGS := -std=c++17 -Wall -Wextra -O2 -march=native
INCLUDES := -I./include -I./src
LDFLAGS := -lz -lpthread

# ç›®å½•è®¾ç½®
SRC_DIR := src
BUILD_DIR := build
LIB_DIR := lib
OBJ_DIR := $(BUILD_DIR)/obj

# æºæ–‡ä»¶
CORE_SRCS := $(SRC_DIR)/core/LoggerCore.cpp
SINK_SRCS := $(wildcard $(SRC_DIR)/sinks/*.cpp)
MANAGER_SRCS := $(wildcard $(SRC_DIR)/manager/*.cpp)
LOGGER_SRCS := $(SRC_DIR)/Logger.cpp

ALL_SRCS := $(CORE_SRCS) $(SINK_SRCS) $(MANAGER_SRCS) $(LOGGER_SRCS)

# ç›®æ ‡æ–‡ä»¶
OBJS := $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(ALL_SRCS))

# åº“æ–‡ä»¶
STATIC_LIB := $(LIB_DIR)/liblogger.a
SHARED_LIB := $(LIB_DIR)/liblogger.so

# æµ‹è¯•ç¨‹åº
TEST_PROG := test_logger

# ============================================
# ä¸»ç›®æ ‡
# ============================================

.PHONY: all clean test install help static shared

# é»˜è®¤ç¼–è¯‘é™æ€åº“
all: static

# ç¼–è¯‘é™æ€åº“
static: $(STATIC_LIB)

# ç¼–è¯‘åŠ¨æ€åº“
shared: $(SHARED_LIB)

# ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•
test: $(TEST_PROG)
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@./$(TEST_PROG)

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	@rm -rf $(BUILD_DIR) $(LIB_DIR) $(TEST_PROG)
	@rm -rf ./logs ./test_logs
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©
help:
	@echo "å¯ç”¨ç›®æ ‡:"
	@echo "  make          - ç¼–è¯‘é™æ€åº“ (é»˜è®¤)"
	@echo "  make static   - ç¼–è¯‘é™æ€åº“"
	@echo "  make shared   - ç¼–è¯‘åŠ¨æ€åº“"
	@echo "  make test     - ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•"
	@echo "  make install  - å®‰è£…åˆ°ç³»ç»Ÿ"
	@echo "  make clean    - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"

# ============================================
# ç¼–è¯‘è§„åˆ™
# ============================================

# åˆ›å»ºç›®å½•
$(OBJ_DIR) $(LIB_DIR):
	@mkdir -p $@
	@mkdir -p $(OBJ_DIR)/core
	@mkdir -p $(OBJ_DIR)/sinks
	@mkdir -p $(OBJ_DIR)/manager

# ç¼–è¯‘ç›®æ ‡æ–‡ä»¶
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo "ğŸ“¦ ç¼–è¯‘: $<"
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# é™æ€åº“
$(STATIC_LIB): $(OBJS) | $(LIB_DIR)
	@echo "ğŸ“š ç”Ÿæˆé™æ€åº“: $@"
	@$(AR) rcs $@ $^
	@echo "âœ… é™æ€åº“ç¼–è¯‘å®Œæˆ: $(STATIC_LIB)"

# åŠ¨æ€åº“
$(SHARED_LIB): $(OBJS) | $(LIB_DIR)
	@echo "ğŸ“š ç”ŸæˆåŠ¨æ€åº“: $@"
	@$(CXX) -shared -o $@ $^ $(LDFLAGS)
	@echo "âœ… åŠ¨æ€åº“ç¼–è¯‘å®Œæˆ: $(SHARED_LIB)"

# æµ‹è¯•ç¨‹åº
$(TEST_PROG): test_logger.cpp $(STATIC_LIB)
	@echo "ğŸ”¨ ç¼–è¯‘æµ‹è¯•ç¨‹åº..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) $< -o $@ -L$(LIB_DIR) -llogger $(LDFLAGS)
	@echo "âœ… æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ: $(TEST_PROG)"

# ============================================
# å®‰è£…è§„åˆ™ï¼ˆå¯é€‰ï¼‰
# ============================================

PREFIX ?= /usr/local
INSTALL_INC_DIR := $(PREFIX)/include
INSTALL_LIB_DIR := $(PREFIX)/lib

install: $(STATIC_LIB)
	@echo "ğŸ“¥ å®‰è£…åˆ° $(PREFIX)..."
	@mkdir -p $(INSTALL_INC_DIR)/logger
	@mkdir -p $(INSTALL_LIB_DIR)
	@cp -r include/logger/* $(INSTALL_INC_DIR)/logger/
	@cp $(STATIC_LIB) $(INSTALL_LIB_DIR)/
	@echo "âœ… å®‰è£…å®Œæˆ"

uninstall:
	@echo "ğŸ—‘ï¸  å¸è½½..."
	@rm -rf $(INSTALL_INC_DIR)/logger
	@rm -f $(INSTALL_LIB_DIR)/liblogger.a
	@echo "âœ… å¸è½½å®Œæˆ"

# ============================================
# ä¾èµ–å…³ç³»ï¼ˆå¯é€‰ï¼Œç”¨äºå¢é‡ç¼–è¯‘ï¼‰
# ============================================

-include $(OBJS:.o=.d)

$(OBJ_DIR)/%.d: $(SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $(patsubst %.d,%.o,$@) $< > $@