CXX := g++
CXXFLAGS := -std=c++17 -Wall -Wextra -O2 -march=native
INCLUDES := -I./include -I./src
LDFLAGS := -lz -lpthread

SRC_DIR := src
BUILD_DIR := build
LIB_DIR := lib
OBJ_DIR := $(BUILD_DIR)/obj

# Logger åº“çš„æ‰€æœ‰æºæ–‡ä»¶
LOGGER_SRCS := $(shell find $(SRC_DIR) -name "*.cpp" -not -path "*test/*")
# Logger åº“çš„ç›®æ ‡æ–‡ä»¶ (.o)ï¼Œæ”¾åœ¨ build/obj ç›®å½•ä¸‹
LOGGER_OBJS := $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(LOGGER_SRCS))

# æµ‹è¯•ç¨‹åºçš„æºæ–‡ä»¶
TEST_SRCS := test_logger.cpp
# æµ‹è¯•ç¨‹åºçš„ç›®æ ‡æ–‡ä»¶ (.o)ï¼Œå¯ä»¥æ”¾åœ¨ build/obj ç›®å½•ä¸‹ï¼Œæˆ–è€…ç›´æ¥ç¼–è¯‘é“¾æ¥
TEST_OBJS := $(patsubst %.cpp,$(OBJ_DIR)/%.o,$(TEST_SRCS))

# æœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åºå
TARGET := test_logger

.PHONY: all clean run test

# é»˜è®¤ç›®æ ‡ï¼šç¼–è¯‘æµ‹è¯•ç¨‹åºå¹¶è¿è¡Œ
all: $(TARGET)

# ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•ç¨‹åº
run: $(TARGET)
	@echo ""
	@echo "ğŸš€ Running $(TARGET)..."
	@./$(TARGET)

# ç¼–è¯‘æµ‹è¯•ç¨‹åº
$(TARGET): $(LOGGER_OBJS) $(TEST_OBJS)
	@echo ""
	@echo "ğŸ”— Linking executable: $@"
	@mkdir -p $(LIB_DIR) $(OBJ_DIR) # ç¡®ä¿ç›®å½•å­˜åœ¨
	@$(CXX) $^ -o $@ $(LDFLAGS)
	@echo "âœ… Executable $(TARGET) generated"

# ç¼–è¯‘ Logger åº“çš„ .cpp æ–‡ä»¶åˆ° .o æ–‡ä»¶
# æ¨¡å¼åŒ¹é…ï¼šbuild/obj/core/LoggerCore.o from src/core/LoggerCore.cpp
$(LOGGER_OBJS): $(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	@echo "ğŸ“¦ Compiling Logger source: $<"
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ç¼–è¯‘ test_logger.cpp åˆ° .o æ–‡ä»¶
$(TEST_OBJS): $(OBJ_DIR)/%.o: %.cpp
	@echo "ğŸ“¦ Compiling Test source: $<"
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "ğŸ§¹ Cleaning build files..."
	@rm -rf $(BUILD_DIR) $(LIB_DIR) $(TARGET) $(OBJ_DIR)
	@echo "âœ… Clean complete"